name: Release Consistency

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to validate (example: v0.2.0)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  consistency:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.ref_type == 'tag' && github.ref_name || inputs.tag }}
    steps:
      - name: Ensure release tag is provided
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${RELEASE_TAG:-}" ]]; then
            echo "Release tag is required (push tag or workflow_dispatch input)." >&2
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify tag, pyproject, manifest, and changelog consistency
        shell: bash
        run: |
          set -euo pipefail

          tag_version="${RELEASE_TAG#v}"
          pyproject_version="$(sed -n 's/^version = \"\(.*\)\"$/\1/p' pyproject.toml | head -n 1)"
          manifest_version="$(jq -r '."."' .release-please-manifest.json)"

          if [[ "$pyproject_version" != "$tag_version" ]]; then
            echo "Mismatch: tag version ($tag_version) != pyproject version ($pyproject_version)" >&2
            exit 1
          fi

          if [[ "$manifest_version" != "$tag_version" ]]; then
            echo "Mismatch: tag version ($tag_version) != release-please manifest version ($manifest_version)" >&2
            exit 1
          fi

          if ! grep -Eq "^## \[$tag_version\]" CHANGELOG.md; then
            echo "Missing changelog section for [$tag_version] in CHANGELOG.md" >&2
            exit 1
          fi

          echo "Consistency checks passed for tag $RELEASE_TAG"
